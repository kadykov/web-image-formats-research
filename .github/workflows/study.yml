# Run encoding studies on GitHub Actions infrastructure, deploy an
# interactive report to GitHub Pages, and publish results as a
# GitHub Release.
#
# This workflow is designed for on-demand use only — it is NOT triggered
# by pushes or pull requests.  Each study runs as a parallel job inside
# the project's dev container image, which provides all native encoding
# and quality-measurement tools (avifenc, cjxl, cwebp, cjpeg,
# ssimulacra2, butteraugli, ffmpeg).
#
# Prerequisites:
#   Repository Settings → Pages → Source must be set to
#   "Deploy from a branch" with branch "gh-pages" and folder "/ (root)".
#
# Workflow structure:
#   1. build-image     – Build and push the dev container image to GHCR
#   2. prepare         – Compute the matrix of studies to run
#   3. fetch-dataset   – Download the dataset and upload as artifact
#   4. run-study       – One parallel job per study (encode + measure + analyze)
#   5. generate-report – Combine all results into an interactive HTML report
#   6. deploy-report   – Publish the report to GitHub Pages (report/ subdirectory)
#   7. release         – Tag the commit and create a GitHub Release with assets

name: Run Studies

on:
  workflow_dispatch:
    inputs:
      time_budget:
        description: "Time budget per study (e.g. 1h, 2h, 30m)"
        required: false
        default: "2h"
        type: string
      studies:
        description: 'Comma-separated study IDs, or "all" for every study'
        required: false
        default: "all"
        type: string

concurrency:
  group: studies
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  DATASET_ID: div2k-valid

jobs:
  # ── 1. Build container image ────────────────────────────────────────
  build-image:
    name: Build Container Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: type=sha

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── 2. Prepare study matrix ─────────────────────────────────────────
  prepare:
    name: Prepare Study Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute matrix
        id: set-matrix
        run: |
          input="${{ inputs.studies }}"
          if [ "$input" = "all" ] || [ -z "$input" ]; then
            studies=$(ls config/studies/*.json \
              | xargs -I{} basename {} .json \
              | jq -R . | jq -s -c .)
          else
            studies=$(echo "$input" \
              | tr ',' '\n' | sed 's/^ *//;s/ *$//' \
              | jq -R . | jq -s -c .)
          fi
          echo "matrix={\"study\":$studies}" >> "$GITHUB_OUTPUT"
          echo "Studies to run: $studies"

  # ── 3. Fetch dataset ────────────────────────────────────────────────
  fetch-dataset:
    name: Fetch Dataset
    runs-on: ubuntu-latest
    needs: build-image
    container:
      image: ${{ needs.build-image.outputs.image-tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install project
        run: pip install -e .

      - name: Fetch dataset
        run: python3 scripts/fetch_dataset.py ${{ env.DATASET_ID }}

      - name: Upload dataset artifact
        uses: actions/upload-artifact@v4
        with:
          name: dataset
          path: data/datasets/
          retention-days: 1
          compression-level: 1        # PNGs are already compressed

  # ── 4. Run each study in parallel ──────────────────────────────────
  run-study:
    name: "Study: ${{ matrix.study }}"
    runs-on: ubuntu-latest
    needs: [build-image, prepare, fetch-dataset]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    container:
      image: ${{ needs.build-image.outputs.image-tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install project
        run: pip install -e .

      - name: Download dataset
        uses: actions/download-artifact@v4
        with:
          name: dataset
          path: data/datasets/

      - name: Verify tools
        run: |
          echo "Encoding tools:"
          command -v cjpeg    && echo "  ✓ cjpeg (JPEG)"
          command -v cwebp    && echo "  ✓ cwebp (WebP)"
          command -v avifenc  && echo "  ✓ avifenc (AVIF)"
          command -v cjxl     && echo "  ✓ cjxl (JPEG XL)"
          echo "Quality measurement tools:"
          command -v ssimulacra2      && echo "  ✓ ssimulacra2"
          command -v butteraugli_main && echo "  ✓ butteraugli_main"
          command -v ffmpeg           && echo "  ✓ ffmpeg"

      - name: Run pipeline
        run: |
          python3 scripts/run_pipeline.py "${{ matrix.study }}" \
            --time-budget "${{ inputs.time_budget || '2h' }}" \
            --save-worst-image

      - name: Run analysis
        run: python3 scripts/analyze_study.py "${{ matrix.study }}"

      - name: Generate visual comparison
        run: python3 scripts/generate_comparison.py "${{ matrix.study }}"

      - name: Upload study results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: study-results-${{ matrix.study }}
          path: |
            data/metrics/${{ matrix.study }}/
            data/analysis/${{ matrix.study }}/
          retention-days: 90

  # ── 5. Generate interactive HTML report ─────────────────────────────
  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [build-image, run-study]
    if: ${{ !cancelled() && needs.build-image.result == 'success' }}
    container:
      image: ${{ needs.build-image.outputs.image-tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install project
        run: pip install -e .

      - name: Download all study results
        uses: actions/download-artifact@v4
        with:
          pattern: study-results-*
          path: data/
          merge-multiple: true

      - name: List available results
        run: |
          echo "=== Metrics ==="
          find data/metrics -name "*.json" -type f 2>/dev/null || echo "  (none)"
          echo "=== Analysis ==="
          find data/analysis -type f -not -path "*/comparison/*" 2>/dev/null | head -20 || echo "  (none)"
          echo "=== Comparison images ==="
          find data/analysis -path "*/comparison/*" -type f 2>/dev/null | head -30 || echo "  (none)"

      - name: Generate report
        run: python3 scripts/generate_report.py

      - name: Generate release notes
        run: python3 scripts/generate_release_notes.py --output release-notes.md

      - name: Prepare release assets
        run: python3 scripts/prepare_release_assets.py --output-dir release-assets

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: report
          path: data/report/

      - name: Upload release materials artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-materials
          path: |
            release-assets/
            release-notes.md

  # ── 6. Deploy report to GitHub Pages ────────────────────────────────
  deploy-report:
    name: Deploy Report to GitHub Pages
    runs-on: ubuntu-latest
    needs: generate-report
    if: ${{ !cancelled() && needs.generate-report.result == 'success' }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download report artifact
        uses: actions/download-artifact@v4
        with:
          name: report
          path: report-output/

      - name: Deploy report to gh-pages/report/
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./report-output
          destination_dir: report

      - name: Deploy landing page to gh-pages root
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pages
          keep_files: true

  # ── 7. Create GitHub Release with assets ────────────────────────────
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: generate-report
    if: ${{ !cancelled() && needs.generate-report.result == 'success' }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release materials
        uses: actions/download-artifact@v4
        with:
          name: release-materials
          path: ./

      - name: Generate tag name
        id: tag
        run: |
          TAG="study-$(date -u +%Y%m%d-%H%M%S)"
          echo "name=$TAG" >> "$GITHUB_OUTPUT"
          echo "Tag: $TAG"

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.tag.outputs.name }}" -m "Study run ${{ steps.tag.outputs.name }}"
          git push origin "${{ steps.tag.outputs.name }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.name }}
          name: "Study Results — ${{ steps.tag.outputs.name }}"
          body_path: release-notes.md
          files: release-assets/*
